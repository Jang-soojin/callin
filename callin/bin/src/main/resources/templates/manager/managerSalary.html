<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="@{layout/default}">

<th:block layout:fragment="customContents"> 
<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
		<!-- Content Header (Page header) -->
		<section class="content-header">
			<div class="container-fluid">
				<div class="row mb-2">
					<div class="col-sm-6">
						<h1 th:text="${midTitle}">급여 정산</h1>
					</div>
					<div class="col-sm-6">
						<ol class="breadcrumb float-sm-right">
							<li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
							<li class="breadcrumb-item active" th:text="${midTitle}">급여 정산</li>
						</ol>
					</div>
				</div>
			</div>
			<!-- /.container-fluid -->
		</section>

		<!-- Main content -->
		<section class="content">
			<div class="container-fluid">
				<div class="row">
					<!-- left column -->
					<div class="col-md-4">
						<!-- general form elements -->
						<div class="card card-secondary">
							<div class="card-header">
								<h3 class="card-title" th:text="${cardTitle}">매니저 상세 정보</h3>
							</div>
							<!-- /.card-header -->
							<!-- form start -->
							<form id="managerInfo" name="managerInfo">
								<div class="card-body">
									<p>매니저 선택</p>
									<div class="input-group mb-3">
										<div class="input-group-prepend">
											<button type="button" onclick="popUp()" class="btn btn-secondary">선택</button>
										</div>
										<!-- /btn-group -->
										<input type="text" class="form-control" id="managerId" placeholder="ID" th:value="${managerId}" readonly="readonly">
									</div>
									<div class="form-group">
										<label for="managerName">이름</label> 
										<input type="text" class="form-control" id="managerName" placeholder="Name"	th:value="${managerName}" readonly="readonly">
									</div>
									<div class="form-group">
										<label for="managerContractType">계약 유형</label> 
										<input type="text" class="form-control" id="managerContractType" placeholder="Contract-Type" th:value="${ContractType}"	readonly="readonly">
									</div>
									<div class="form-group">
										<label for="managerHourlyRate">단위 급여</label> 
										<input type="number" class="form-control" id="managerHourlyRate" placeholder="Hourly-Rate" th:value="${HourlyRate}" readonly="readonly">
									</div>
									<!-- Date range -->
									<div class="form-group">
										<label>급여 산정 기간</label>
										<div class="input-group">
											<div class="input-group-prepend">
												<span class="input-group-text"> 
													<i class="far fa-calendar-alt"></i>
												</span>
											</div>
											<input type="text" class="form-control float-right"	id="reservation">
										</div>
										<!-- /.input group -->
									</div>
									<!-- /.form group -->
									<div class="form-check">
										<input type="checkbox" class="form-check-input"
											id="exampleCheck1"> <label class="form-check-label"
											for="exampleCheck1">Check me out</label>
									</div>
								</div>
								<!-- /.card-body -->

								<div class="card-footer">
									<button type="button" class="btn btn-secondary" id="checkWorkHour">근무시간 조회</button>
								</div>
							</form>
						</div>
						<!-- /.card -->
					</div>
					<!--/.col (left) -->
					<div class="col-md-4">
						<!-- general form elements -->

						<div class="card card-secondary">
							<div class="card-header">
								<h3 class="card-title">정산 상세 내역</h3>
							</div>
							<!-- /.card-header -->
							<!-- form start -->
							<form>
								<div class="card-body">
									<div class="form-group">
										<p>
											<label for="TWH">기본급</label>
										</p>
										<input type="number" id="TWH" class="form-control"
											placeholder="Total Working Hours" readonly="readonly">
									</div>
									<div class="form-group">
										<label for="bonus">상여금(Bonus)</label> <input type="number"
											id="bonus" class="form-control" placeholder="Bonus">
									</div>
									<div class="form-group">
										<label for="deduction">식대</label> <input type="number"
											id="deduction" class="form-control" placeholder="Deduction">
									</div>
									<div class="form-group">
										<label for="deduction">차량지원비</label> <input type="number"
											id="deduction" class="form-control" placeholder="Deduction">
									</div>
									<div class="form-group">
										<label for="deduction">기타 수당</label> <input type="number"
											id="deduction" class="form-control" placeholder="Deduction">
									</div>
									<div>
										<button type="button"
											class="btn btn-block btn-secondary btn-s">정산</button>
									</div>
									<br>
									<div class="form-group">
										<label>비과세 제외 합계</label> <input type="number"
											class="form-control" placeholder="Total Wage(PHP)"
											readonly="readonly">
									</div>
									<div class="form-group">
										<label>최종 지급액(KRW)</label> <input type="number"
											class="form-control" placeholder="Total Wage(KRW)"
											readonly="readonly">
									</div>
								</div>
								<!-- /.card-body -->
							</form>
						</div>

						<!--/.col (right) -->

					</div>
					<!-- Right column -->
					<div class="col-md-4">
						<!-- general form elements -->

						<div class="card card-secondary">
							<div class="card-header">
								<h3 class="card-title">공제 내역</h3>
							</div>
							<!-- /.card-header -->
							<!-- form start -->
							<form>
								<div class="card-body">
									<div class="form-group">
										<p>
											<label for="TWH">소득세</label>
										</p>
										<input type="number" id="TWH" class="form-control"
											placeholder="Total Working Hours" readonly="readonly">
									</div>
									<div class="form-group">
										<label for="bonus">지방세</label> <input type="number" id="bonus"
											class="form-control" placeholder="Bonus">
									</div>
									<div class="form-group">
										<label for="deduction">국민연금</label> <input type="number"
											id="deduction" class="form-control" placeholder="Deduction">
									</div>
									<div class="form-group">
										<label for="deduction">건강보험</label> <input type="number"
											id="deduction" class="form-control" placeholder="Deduction">
									</div>
									<div class="form-group">
										<label for="deduction">장기요양보험</label> <input type="number"
											id="deduction" class="form-control" placeholder="Deduction">
									</div>
									<div class="form-group">
										<label for="deduction">고용보험</label> <input type="number"
											id="deduction" class="form-control" placeholder="Deduction">
									</div>
									<div>
										<button type="button"
											class="btn btn-block btn-secondary btn-s">정산</button>
									</div>
									<br>
									<div class="form-group">
										<label>기타 공제 합계</label> <input type="number"
											class="form-control" placeholder="Total Wage(PHP)"
											readonly="readonly">
									</div>
									<div class="form-group">
										<label>최종 지급액(KRW)</label> <input type="number"
											class="form-control" placeholder="Total Wage(KRW)"
											readonly="readonly">
									</div>
								</div>
								<!-- /.card-body -->
								<div class="card-footer">
									<button type="button" class="btn btn-block btn-secondary btn-s">저장</button>
								</div>
							</form>
						</div>
						<!--/.col (right) -->
					</div>
					<!-- /.row -->
				</div>
				<!-- /.container-fluid -->
		</section>
		<!-- /.content -->
	</div>
	<!-- /.content-wrapper -->
<!-- 김경수의 자바스크립트 코드 시작  -->
<!-- jQuery -->
	<script th:src="@{/AdminLTE-master/plugins/jquery/jquery.min.js}"></script>
	<script type="text/javascript">
		function popUp() {
			var popupOpt = 'width=820px, height=777px, left=100, top=100, scrollbar=no';
			var popHref = '/admin/teacher/teacherList';
			open(popHref, "페이지 이름 뭐하지", popupOpt);
		}
	</script>


	<script>
	
		$(function() {
			//Date range picker
			$('#reservation').daterangepicker()
		})

		// Ajax를 통해 선택한 강사 정보와 급여 산정기간 data를 통해 총 근무 시간(분) 조회 및 입력.

		$(function() {
			$("#checkWorkHour").click(function() {
				var managerId = $("#managerId").val()
				var dateRange1 = $("#reservation")[0].value.substring(0, 10);
				var dateRange2 = $("#reservation")[0].value.substring(13, 23);

				var MM1 = dateRange1.substring(0, 2)
				var DD1 = dateRange1.substring(3, 5)
				var YYYY1 = dateRange1.substring(6, 10)
				var newDateFormat1 = YYYY1 + "-" + MM1 + "-" + DD1;

				var MM2 = dateRange2.substring(0, 2)
				var DD2 = dateRange2.substring(3, 5)
				var YYYY2 = dateRange2.substring(6, 10)
				var newDateFormat2 = YYYY2 + "-" + MM2 + "-" + DD2

				/* ********************************************** */
				//$.ajax() 호출시 ajax에 관련된 객체를 반환한다.
				var request = $.ajax({
					url : "/admin/teacher/teacherSalaryAjax2", //요청 url
					method : "POST", //요청 방식
					data : {
						managerId : managerId,
						dateRange1 : newDateFormat1,
						dateRange2 : newDateFormat2
					}, //요청하는 곳에 전달될 데이타
					dataType : "json" //응답되어 받은 데이타를 parsing 시킬 방식
				});
				request.done(function(data) {
					$("#TWH").val(data) //data는 총 근무시간(분)으로 입력
				});

				request.fail(function(jqXHR, textStatus) {

					alert("요청 실패: " + textStatus);

				});

			})
		})

		$(function() {
			$("#calc").click(function() {
				var twh = $("#TWH").val();
				var hr = $("#managerHourlyRate").val();
				var bonus = $("#bonus").val();
				var deduction = $("#deduction").val();

				var sum = Math.ceil(twh * (hr / 60)
						+ (bonus - deduction));
				$("#totalSalaryPHP").val(sum)
				/* -------------------------------------------------------------------------------- */
				var request = $
						.ajax({
							url : "http://api.exchangeratesapi.io/v1/2021-09-05?access_key=1d4ae7f592a21345bdf8b8de12dab34c&base =KRW & symbols = PHP", //요청 url
							method : "POST", //요청 방식
							data : {}, //요청하는 곳에 전달될 데이타
							dataType : "json" //응답되어 받은 데이타를 parsing 시킬 방식
						});
				request.done(function(data) {
					//data.rate.PHP = 필리핀 페소-유로 환율
					//data.rate.KRW = 한국 원-유로 환율
					//무료버전 API에서는 유로 기준 환율밖에 적용이 안되므로 더 정확하게 사용하려면 유료버전 사용하자.
					var sumKRW = Math
							.ceil((sum / (data.rates.PHP))
									* (data.rates.KRW));
					$("#totalSalaryKRW").val(sumKRW);
				});

				request.fail(function(jqXHR, textStatus) {

					alert("요청 실패: " + textStatus);

				});
			})
		})
	</script>
</th:block>

</html>